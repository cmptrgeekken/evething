{% extends "web_template.html" %}
{% import 'macros/common.html' as common %}

{% block title %}Pricer{% endblock %}

{% block content %}

<section class="bg-19 bg-center bg-cover">
    <div>
        <div class="container section-sm">
            <h1 class="top-title">Pricing Calculator</h1>
        </div>
    </div>
</section>



<section class="container section-md">
    <div class="row">
        <div class="col-md-4">
            {% if bad_lines|length > 0 %}
                <div class="alert alert-danger" role="alert">
                    <h4 class="alert-heading">The following lines could not be parsed:</h4>
                    <ul>
                        {% for line in bad_lines %}
                            <li>{{ line }}</li>
                        {% endfor %}
                    </ul>
                </div>
            {% endif %}
            <h2><a data-toggle="collapse" href="#formEntry" aria-expanded="False"><i class="fa fa-chevron-right"></i>Desired Items</a></h2>
            <form id="formEntry" class="collapse form-horizontal{% if items|length == 0 %} in{% endif %}" method="post" action="{{ url('pgsus.views.pricer') }}">
                {{ csrf() }}
                <textarea name="text_input" rows="10" style="width: 100%;" placeholder="Paste desired items here (e.g., 1000 Tritanium)">{{ text_input }}</textarea>
                <div class="form-group">
                    <label class="col-sm-7 col-form-label" for="compress_ores">Compress Mineral Imports:</label>
                    <div class="col-sm-1">
                        <input id="compress_ores" type="checkbox"{% if compress_ores %} checked="checked"{% endif %} name="compress_ores" value="true"/>
                    </div>
                </div>
                <div class="form-group">
                    <label class="col-sm-7 col-form-label" for="multiplier">Multiplier:</label>
                    <div class="col-sm-1">
                        <input id="multiplier" type="number" min="1" name="multiplier" value="{{ multiplier }}"/>
                    </div>
                </div>
                <div class="form-group">
                    <label class="col-sm-7 col-form-label" for="buy_all_tolerance">Buy-All Tolerance:</label>
                    <div class="col-sm-1">
                        <input id="buy_all_tolerance" type="number" min="0" max="1" step=".01" name="buy_all_tolerance" value="{{ buy_all_tolerance }}"/>
                    </div>
                </div>
                <div class="form-group">
                      <label class="col-sm-2 col-form-label" for="destination_station">Build station:</label>
                      <div class="col-sm-8">
                          <select name="destination_station" id="destination_station" class="js-select2 input-lg">
                              {% for sta in stations %}
                              <option value="{{sta}}"{%if stations[sta].z_destination_selected %} selected{% endif %}>{{ stations[sta].name }}</option>
                              {% endfor %}
                          </select>
                      </div>
                  </div>
                <div class="form-group">
                      <label class="col-sm-2 col-form-label" for="source_stations">Purchase Stations:</label>
                      <div class="col-sm-8">
                          <select name="source_stations" id="source_stations" class="js-select2 input-lg" multiple="multiple">
                              {% for sta in stations %}
                              <option value="{{sta}}"{%if stations[sta].z_source_selected %} selected{% endif %}>{{ stations[sta].name }}</option>
                              {% endfor %}
                          </select>
                      </div>
                  </div>
                <button type="submit" class="btn btn-primary">
                    Submit
                </button>
            </form>
        </div>
        {% if items_list|length > 0 %}
        <div class="row">
            <div class="col-md-12">
                <h2>
                    Items to Purchase
                </h2>
                <div class="form-group">
                    {% if has_unfulfilled %}
                    <h3>Could Not Fulfill!</h3>
                    <div class="row">
                        <div class="col-md-6">
                            <table class="table table-bordered">
                                <tr>
                                    <th>Item</th>
                                    <th class="align-right">Qty Needed</th>
                                    <th class="align-right">Qty Missing</th>
                                </tr>
                                {% for item in items_list if item.z_qty_remaining > 0 %}
                                    <tr>
                                        <th>{{ item.name }}</th>
                                        <td class="align-right">{{ item.z_qty_needed|commas }}</td>
                                        <td class="align-right">{{ item.z_qty_remaining|commas }}</td>
                                    </tr>
                                {% endfor %}
                            </table>
                        </div>
                    </div>

                    {% endif %}
                </div>

                {% for sname, orders in station_orders.items() %}
                <div class="form-group">
                    <h3>
                        {{ sname }}
                        {% if orders['last_updated'] %}
                            <i>
                                <small>
                                (Last Updated: <time class="timeago" datetime="{{orders['last_updated']|timeago}}">{{ orders['last_updated'].last_updated }}</time>)
                                </small>
                            </i>
                        {% endif %}
                        <br/>
                        <button class="btn btn-xs" type="button" data-clipboard-text="{{ orders['multibuy_all'] }}">
                            Multibuy All
                        </button>

                        <button class="btn btn-xs" type="button" data-clipboard-text="{{ orders['multibuy_best'] }}">
                            Multibuy Only Best
                        </button>
                    </h3>
                    <table class="table table-bordered">
                        <tr>
                            <th>Item</th>
                            <th class="align-right">Qty</th>
                            <th class="align-right hidden-xs">Volume</th>
                            <th class="align-right">Total<span class="hidden-xs"> (Buy All)</span></th>
                            <th class="align-right hidden-xs"><abbr title="Values marked green save at least 2% if purchasing individual sell orders.">Total (Optimal)</abbr></th>
                        </tr>

                        {% for order_list in orders['orders'] %}
                            <tr>
                                <th>{{ order_list.item_name }}</th>
                                <td class="align-right">{{ order_list.total_quantity|commas }}</td>
                                <td class="align-right hidden-xs">{{ (order_list.total_volume)|commas }} m<sup>3</sup></td>
                                <td class="align-right">
                                    <a href="#" data-toggle="modal" data-target="#modal-{{ order_list.station_id }}-{{ order_list.item_id }}">
                                        {{ order_list.total_price_multibuy|commas }}
                                    </a>
                                </td>
                                <td class="align-right hidden-xs{% if not order_list.multibuy_ok %} buy-best{% endif %}">{{ order_list.total_price_best|commas }}</td>
                            </tr>
                        {% endfor %}
                        <tr>
                            <td class=""></td>
                            <th class="align-right">Subtotal</th>
                            <th class="align-right hidden-xs">{{ orders['total_volume']|commas }} m<sup>3</sup></th>
                            <th class="align-right">{{ orders['total_price_multibuy']|commas }}</th>
                            <th class="align-right hidden-xs">{{ orders['total_price_best']|commas }}</th>
                        </tr>
                        <tr>
                            <td></td>
                            <td class="hidden-xs"></td>
                            <th class="align-right">Shipping</th>
                            <th class="align-right">{{ orders['total_shipping']|commas }}</th>
                            <th class="align-right">{{ orders['total_shipping']|commas }}</th>
                        </tr>
                        <tr>
                            <td></td>
                            <td class="hidden-xs"></td>
                            <th class="align-right">Total</th>
                            <th class="align-right">{{ (orders['total_shipping']+orders['total_price_multibuy'])|commas }}</th>
                            <th class="align-right">{{ orders['total_price_with_shipping']|commas }}</th>
                        </tr>
                    </table>
                </div>
                {% endfor %}

                <h3>Totals</h3>
                <table class="table table-bordered">
                    <tr>
                        <th>Item</th>
                        <th class="align-right">Qty</th>
                        <th class="align-right hidden-xs">Volume</th>
                        <th class="align-right">Total<span class="hidden-xs"> (Buy All)</span></th>
                        <th class="align-right hidden-xs">Total (Optimal)</th>
                    </tr>

                    {% for item in items_list %}
                        <tr>
                            <th>{{ item.name }}{% if item.z_qty_remaining > 0 %}<br/><small>** Couldn't Fulfill All!! **</small>{% endif %}</th>
                            <td class="align-right">{{ item.z_qty|commas }}{% if item.z_qty_remaining > 0 %}<br/><small>({{ item.z_qty_remaining|commas }} left)</small>{% endif %}</td>
                            <td class="align-right hidden-xs">{{ (item.z_ttl_volume)|commas }} m<sup>3</sup></td>
                            <td class="align-right">{{ item.z_ttl_price_multibuy|commas }}</td>
                            <td class="align-right hidden-xs">{{ item.z_ttl_price_best|commas }}</td>
                        </tr>
                    {% endfor %}
                    <tr>
                        <td class=""></td>
                        <th class="align-right">Subtotal</th>
                        <th class="align-right hidden-xs">{{ total_volume|commas }} m<sup>3</sup></th>
                        <th class="align-right">{{ total_worst|commas }}</th>
                        <th class="align-right hidden-xs">{{ total_best|commas }}</th>
                    </tr>
                    <tr>
                        <td></td>
                        <td class="hidden-xs"></td>
                        <th class="align-right">Shipping</th>
                        <th class="align-right">{{ total_shipping|commas }}</th>
                        <th class="align-right">{{ total_shipping|commas }}</th>
                        <td></td>
                    </tr>
                    <tr>
                        <td></td>
                        <td class="hidden-xs"></td>
                        <th class="align-right">Total</th>
                        <th class="align-right">{{ (total_shipping+total_worst)|commas }}</th>
                        <th class="align-right">{{ total_price_with_shipping|commas }}</th>
                    </tr>
                </table>

            </div>
        </div>
        {% endif %}
    </div>
</section>
{% endblock %}

{% block modals %}
    {% for sname, orders in station_orders.items() %}
        {% for o in orders['orders']: %}
            <div class="modal fade" id="modal-{{  o.station_id }}-{{ o.item_id }}" tabindex="-1" role="dialog">
                <div class="modal-dialog" role="document">
                    <div class="modal-content">
                        <div class="modal-header">
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                            <h4 class="modal-title">Market for {{ o.item_name }} in {{ sname }} (Need {{ o.total_quantity|commas }} Items)</h4>
                        </div>
                        <div class="modal-body modal-body-scroll">
                            <table class="table table-striped">
                                <tr>
                                    <th>Quantity</th>
                                    <th>Price</th>
                                    <th>Shipping</th>
                                    <th>Total</th>
                                </tr>
                                {% for order in o.orders %}
                                <tr class="{% if order.z_order_qty > 0 %}market-order-buy{% endif %}">
                                    <td class="align-right">
                                        <div>{{ order.volume_remaining|commas }}</div>
                                        {% if order.z_order_qty > 0 %}
                                        <div><abbr title="Quantity to Purchase">{{ order.z_order_qty|commas }}</abbr></div>
                                        {% endif %}
                                    </td>
                                    <td class="align-right">
                                        <div>{{ order.price|commas }} ISK</div>
                                        {% if order.z_order_qty > 0 %}
                                            <div><abbr title="Purchase Cost">{{ (order.price*order.z_order_qty)|commas }} ISK</abbr></div>

                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if order.z_shipping > 0 %}
                                            {{ order.z_shipping|commas }} ISK
                                            {% if order.z_order_qty > 0 %}
                                            <div><abbr title="Total Shipping">{{ (order.z_order_qty*order.z_shipping)|commas }}</abbr></div>
                                            {% endif %}
                                        {% else %}
                                        <i>N/A</i>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <div>{{ (order.price|float+order.z_shipping)|commas }} ISK</div>
                                        {% if order.z_order_qty > 0 %}
                                            <div><abbr title="Purchase Cost">{{ ((order.price|float+order.z_shipping)*order.z_order_qty)|commas }} ISK</abbr></div>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </table>
                        </div>
                    </div><!-- /.modal-content -->
                </div><!-- /.modal-dialog -->
            </div><!-- /.modal -->
        {% endfor %}
    {% endfor %}
{% endblock %}